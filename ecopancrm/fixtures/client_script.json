[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "PMS",
  "enabled": 1,
  "modified": "2025-06-06 17:23:59.339213",
  "module": null,
  "name": "PMS Customer Sync v2",
  "script": "frappe.ui.form.on('PMS', {\n    after_save: function(frm) {\n        if (frm.doc.customer) {\n            console.log('üöÄ PMS salvato:', frm.doc.name, 'Customer:', frm.doc.customer);\n            \n            frappe.call({\n                method: 'frappe.client.get_doc',\n                args: {\n                    doctype: 'Ecopan Customer',\n                    name: frm.doc.customer\n                },\n                callback: function(r) {\n                    if (r.message) {\n                        let customer = r.message;\n                        console.log('üìÑ Customer caricato:', customer.name);\n                        \n                        // Controlla se PMS gi√† esiste\n                        let exists = false;\n                        if (customer.pms_list) {\n                            customer.pms_list.forEach(function(row) {\n                                if (row.pms_reference === frm.doc.name) {\n                                    exists = true;\n                                }\n                            });\n                        } else {\n                            customer.pms_list = [];\n                        }\n                        \n                        if (!exists) {\n                            console.log('‚ûï Aggiungendo PMS alla tabella...');\n                            \n                            customer.pms_list.push({\n                                pms_reference: frm.doc.name,\n                                data_creazione: frappe.datetime.get_today(),\n                                stato: 'Attivo'\n                            });\n                            \n                            frappe.call({\n                                method: 'frappe.client.save',\n                                args: {\n                                    doc: customer\n                                },\n                                callback: function(save_r) {\n                                    console.log('‚úÖ Risultato salvataggio:', save_r);\n                                    if (save_r.message) {\n                                        frappe.show_alert({\n                                            message: 'PMS aggiunto al Customer!',\n                                            indicator: 'green'\n                                        });\n                                    }\n                                },\n                                error: function(err) {\n                                    console.error('‚ùå Errore salvataggio:', err);\n                                }\n                            });\n                        } else {\n                            console.log('‚ö†Ô∏è PMS gi√† presente nella tabella');\n                        }\n                    }\n                },\n                error: function(err) {\n                    console.error('‚ùå Errore caricamento customer:', err);\n                }\n            });\n        } else {\n            console.log('‚ö†Ô∏è Campo customer vuoto');\n        }\n    }\n});",
  "view": "Form"
 }
]